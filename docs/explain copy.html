<!doctype html>
<notebook theme="air">
  <title>Meat supply per person (Explain)</title>
  <script id="1" type="text/markdown">
    # ${metaData.chart.title} (Explain)
  </script>
  <script id="34" type="text/markdown">
    *${metaData.columns["Meat, total | 00002943 || Food available for consumption | 0645pc || kilograms per year per capita"].citationShort}*
  </script>
  <script id="33" type="text/markdown">
    ${metaData.chart.note}
  </script>
  <script id="36" type="text/markdown">
    ## Reference country: Chile
  </script>
  <script id="35" type="text/markdown">
    In 1988 Chile had a supply of 32.9 kg (per capita per year).  From then onwards, there has been an upwards trend leading to 92.4 kg in 2022
  </script>
  <script id="18" type="module">
    meatConsumptionChart({ countries: [], highlightYears:[1988, 2022] })
  </script>
  <script id="42" type="text/markdown">
    ## Meat Supply vs GDP per Capita
  </script>
  <script id="43" type="text/markdown">
    In general we can observe an association between income (GDP per Capita) and the amount od meat supply, but tere are some exeptions
  </script>
  <script id="39" type="module">
    meatConsumptionScatterPlot({countries:countries})
  </script>
  <script id="21" type="text/markdown">
    ## Countries that have kept a high level of meat supply over time
  </script>
  <script id="45" type="text/markdown">
    Some countries report a high level of meat consumtion per capita which does not seem to be associated to the increase of income over time.  For example: Australia.
  </script>
  <script id="20" type="module">
    meatConsumptionChart({ countries: ["Australia"] })
  </script>
  <script id="25" type="text/markdown">
    ## High income countries that show recent reduction in meat supply
  </script>
  <script id="46" type="text/markdown" pinned="">
    Some countries had a very high evel of meet consumption but have been decreasing this indicator in recent years. This does not seem to be related to income and is probably a changee in eating behaviors.  Germany used to have much higer levels comparde to Chile in the 80s, but has gone below Chile on recent years
  </script>
  <script id="24" type="module">
    meatConsumptionChart({ countries: ["Germany"], highlightYears:[1988, 2022] })
  </script>
  <script id="47" type="text/markdown" pinned="">
    ## Countries with a permanent low level of meat consumption
  </script>
  <script id="48" type="text/markdown" pinned="">
    Some countries, like India, show very low levels of meat supply per person. This is probably explained by cultural reasons and is not associated to income.
  </script>
  <script id="26" type="module">
    meatConsumptionChart({ countries: ["India"] })
  </script>
  <script id="49" type="text/markdown">
    ## Similar trands to Chile
  </script>
  <script id="50" type="text/markdown">
    Several countries - like China - show a similar trend to Chile, with a progressive growth over time.
  </script>
  <script id="28" type="module">
    meatConsumptionChart({ countries: ["China"] })
  </script>
  <script id="52" type="text/markdown" pinned="">
    ## Case of Bolivia
  </script>
  <script id="53" type="text/markdown" pinned="">
    It is surprising that Bolivia, with much lower income than Chile, shows only a slightly lower levels of meat supply than Chile
  </script>
  <script id="27" type="module">
    meatConsumptionChart({ countries: ["Bolivia"] })
  </script>
  <script id="22" type="module">
    meatConsumptionChart({ countries: ["Argentina$"] })
  </script>
  <script id="23" type="module">
    meatConsumptionChart({ countries: selectCountry, highlightYears:[1990,2022] })
  </script>
  <script id="4" type="module">
    const selectCountry = view(Inputs.select(_.chain(countries).uniq().sort().value(), {
        label: "Select one",
        multiple: true
      }));

  </script>
  <script id="6" type="module">
    function meatConsumptionChart(options) {
      const countries = (options && options.countries) || ["Chile"];
      const highlightYears = (options && options.highlightYears) || [];

      const filtroPaises = new RegExp(
        _.chain(
          _.concat(
            "Chile",
            countries.map((d) => `${d}$`)
          )
        )
          .map((d) => d)
          .join("|")
      );

      const dataPlot = _.chain(data)
        .filter((d) => d.Entity.match(filtroPaises) && d.consumption)
        .sortBy((d) => d.Year)
        .value();

      const dataHighlight = _.chain(data)
        .filter((d) => d.Entity.match(filtroPaises) && d.consumption && highlightYears.includes(d.Year))
        .sortBy((d) => d.Year)
        .value();

      const maxValue = _.chain(dataPlot).map(d => d.consumption).max().value()

      const otrosPaises = _.chain(dataPlot)
        .map((d) => d.Entity)
        .uniq()
        .filter((d) => !d.match(/Chile/))
        .sort()
        .value();

      return Plot.plot({
        title:metaData.chart.title,
        subtitle:metaData.chart.subtitle,
        caption: `Source: ${metaData.chart.citation}`,

        color: { legend: true, domain: _.concat("Chile", otrosPaises) },
        style: { fontSize: 14 },
        width,
        height: 600,
        marginRight: 100,
        marginTop:30,
        //title:"Suministro promedio total de carne per cápita medido en kilogramos por año",
        x: { label: "year" },
        y: { label: metaData.columns["Meat, total | 00002943 || Food available for consumption | 0645pc || kilograms per year per capita"].unit, grid: true },
        marks: [
          Plot.ruleY([0]),
          Plot.ruleX(_.chain(dataHighlight).map(d => d.Year).uniq().value(), {
            stroke: "lightgrey",
          }),
          Plot.text(_.chain(dataHighlight).map(d => d.Year).uniq().value(), {
            x: d => d,
            y: d => maxValue,
            text: d => d,
            dy:-10
          }),
          Plot.lineY(dataPlot, {
            x: "Year",
            y: "consumption",
            stroke: "Entity",
            strokeWidth: (d) => (d.Entity == "Chile" ? 3 : 2)
          }),
          Plot.text(
            dataPlot,
            Plot.selectLast({
              x: "Year",
              y: "consumption",
              z: "Entity",
              fill: "Entity",
              text: "Entity",
              textAnchor: "start",
              //sort: { x: "Year" }, // <-- ensure “last” = rightmost
              dx: 5
            })
          ),
          Plot.dot(dataHighlight, {
            x: "Year",
            y: "consumption",
            fill: "Entity",
          }),
          Plot.text(dataHighlight, {
            x: "Year",
            y: "consumption",
            fill: "black",
            dy:15,
            text: d=> `${d3.format(".1f")(d.consumption)}`
          }),

        ]
      });
    }
  </script>
  <script id="38" type="module">
    function meatConsumptionScatterPlot(options) {
      const countries = (options && options.countries) || ["Chile"];

      const filtroPaises = new RegExp(
        _.chain(_.concat("Chile", countries))
          .map((d) => d)
          .join("|")
      );

      const dataPlot = _.chain(data)
        .filter(
          (d) => d.Entity.match(filtroPaises) && d.consumption && d.Year == 2022
        )
        .sortBy((d) => d.Year)
        .value();

      const otrosPaises = _.chain(dataPlot)
        .map((d) => d.Entity)
        .uniq()
        .filter((d) => !d.match(/Chile/))
        .sort()
        .value();

      return Plot.plot({
        color: { legend: true /*domain: _.concat("Chile", otrosPaises) */ },
        style: { fontSize: 14 },
        width,
        marginRight: 100,
        marginTop:30,
        marginBottom:50,
        title: metaDataMeatGDP.chart.title,
        subtitle: `${metaDataMeatGDP.chart.subtitle}`,
        caption: `Source: ${metaDataMeatGDP.chart.citation}`,
        x: { label:`${metaDataMeatGDP.columns["ny_gdp_pcap_pp_kd"].titleShort} (${metaDataMeatGDP.columns["ny_gdp_pcap_pp_kd"].unit})`, type: "log" },
          y: { label: `${metaDataMeatGDP.columns["meat__total__00002943__food_available_for_consumption__0645pc__kilograms_per_year_per_capita"].titleShort} (${metaDataMeatGDP.columns["meat__total__00002943__food_available_for_consumption__0645pc__kilograms_per_year_per_capita"].unit})`, grid: true },
        marks: [
          Plot.ruleY([0]),
          Plot.dot(dataPlot, {
            x: "gptpc",
            y: "consumption",
            fill: (d) => (d.Entity == "Chile" ? "blue" : "lightgrey"),
            fillOpacity:0.5,
            r: 5
            //strokeWidth: (d) => (d.Entity == "Chile" ? 3 : 2)
          }),
          Plot.text(dataPlot, {
            x: "gptpc",
            y: "consumption",
            //fill: "Entity",
            text: "Entity",
            fontSize:10,
            dy: 10
          })

        ]
      });
    }
  </script>
  <script id="15" type="module">
    const countries = [
      "Argentina",
      "Australia",
      "Bangladesh",
      "Belarus",
      "Bolivia",
      "Brazil",
      "Canada",
      "China",
      "Croatia",
      "Denmark",
      "Ecuador",
      "Egypt",
      "El Salvador",
      "Colombia",
      "Costa Rica",
      "Finland",
      "France",
      "Germany",
      "Greece",
      "Guatemala",
      "Haiti",
      "Honduras",
      "Hong Kong",
      "Hungary",
      "Iceland",
      "India",
      "Ireland",
      "Indonesia",
      "Iran",
      "Iraq",
      "Israel",
      "Italy",
      "Jamaica",
      "Japan",
      "Jordan",
      "Kenya",
      "Kuwait",
      "Luxembourg",
      "Madagascar",
      "Malaysia",
      "Malta",
      "Mexico",
      "Mongolia",
      "Morocco",
      "Mozambique",
      "Myanmar",
      "Nepal",
      "Netherlands",
      "New Zealand",
      "Nicaragua",
      "North Korea",
      "Norway",
      "Pakistan",
      "Paraguay",
      "Peru",
      "Panama",
      "Philippines",
      "Poland",
      "Portugal",
      "Russia",
      "Rwanda",
      "Saudi Arabia",
      "South Africa",
      "Spain",
      "South Korea",
      "Sweden",
      "Switzerland",
      "Taiwan",
      "Thailand",
      "Turkey",
      "Ukraine",
      "United Arab Emirates",
      "United Kingdom",
      "United States",
      "Uruguay",
      "Venezuela",
      "Vietnam",
      "Zimbabwe",
      "Austria"
    ]
  </script>
  <script id="17" type="module">
    const query = `
    WITH regiones as (SELECT Entity, "World regions according to OWID" as region FROM meatData WHERE NOT "World regions according to OWID" ISNULL)


    SELECT meatData.Entity, Code, meatData.Year,  "Meat, total | 00002943 || Food available for consumption | 0645pc || kilograms per year per capita" as consumption, "GDP per capita, PPP (constant 2021 international $)" as gptpc,
      regiones.region

    FROM meatData
    INNER JOIN regiones ON
    meatData.Entity = regiones.Entity
    `

    const data = [... await db.query(query)]
  </script>
  <script id="11" type="module">
    const db = DuckDBClient.of({
      meatData: "https://ourworldindata.org/grapher/meat-consumption-vs-gdp-per-capita.csv?v=1&csvType=full&useColumnShortNames=false"
    });
  </script>
  <script id="29" type="module">
    const metaData = d3.json("https://ourworldindata.org/grapher/meat-supply-per-person.metadata.json?v=1&csvType=full&useColumnShortNames=false")
  </script>
  <script id="40" type="module">
    const metaDataMeatGDP = d3.json("https://ourworldindata.org/grapher/meat-consumption-vs-gdp-per-capita.metadata.json?v=1&csvType=full&useColumnShortNames=true")
  </script>
</notebook>
